{% extends "base.html" %}
{% block title %}Settings{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <h3 class="mb-4"><i class="bi bi-person-gear"></i> Settings</h3>

        <!-- Change Password -->
        <div class="card mb-4">
            <div class="card-header"><h5 class="mb-0">Change Password</h5></div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('auth.change_password') }}">
                    <div class="mb-3">
                        <label class="form-label">Current Password</label>
                        <input type="password" class="form-control" name="current_password" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Password</label>
                        <input type="password" class="form-control" name="new_password" required minlength="6">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Confirm New Password</label>
                        <input type="password" class="form-control" name="confirm_password" required minlength="6">
                    </div>
                    <button type="submit" class="btn btn-primary">Update Password</button>
                </form>
            </div>
        </div>

        <!-- Passkeys -->
        {% if webauthn_available %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Passkeys <span class="badge bg-info">WebAuthn</span></h5>
            </div>
            <div class="card-body">
                <p class="text-muted">Passkeys let you sign in with your fingerprint, face, or device PIN instead of a password.</p>

                {% if credentials %}
                <table class="table table-dark table-hover">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Created</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cred in credentials %}
                        <tr>
                            <td><i class="bi bi-key"></i> {{ cred.name }}</td>
                            <td>{{ cred.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <form method="POST" action="{{ url_for('auth.webauthn_delete', cred_id=cred.id) }}"
                                      onsubmit="return confirm('Delete this passkey?');">
                                    <button class="btn btn-sm btn-outline-danger">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p class="text-muted fst-italic">No passkeys registered.</p>
                {% endif %}

                <div class="mt-3">
                    <div class="input-group" style="max-width: 400px;">
                        <input type="text" class="form-control" id="passkeyName" placeholder="Passkey name (e.g. MacBook)" value="My Passkey">
                        <button class="btn btn-success" onclick="registerPasskey()">
                            <i class="bi bi-plus-lg"></i> Register Passkey
                        </button>
                    </div>
                </div>

                <div id="registerStatus" class="mt-2"></div>
            </div>
        </div>
        {% else %}
        <div class="card mb-4">
            <div class="card-body">
                <p class="text-muted">
                    <i class="bi bi-info-circle"></i>
                    Passkey support requires the <code>py-webauthn</code> package. Install it with:
                    <code>pip install py-webauthn</code>
                </p>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{% if webauthn_available %}
<script>
async function registerPasskey() {
    const name = document.getElementById('passkeyName').value || 'My Passkey';
    const statusDiv = document.getElementById('registerStatus');
    statusDiv.innerHTML = '<span class="text-info"><span class="spinner-border spinner-border-sm"></span> Starting registration...</span>';

    try {
        const optionsRes = await fetch('/auth/webauthn/register/begin', { method: 'POST' });
        if (!optionsRes.ok) throw new Error('Failed to get registration options');
        const options = await optionsRes.json();

        options.challenge = base64urlToBuffer(options.challenge);
        options.user.id = base64urlToBuffer(options.user.id);
        if (options.excludeCredentials) {
            options.excludeCredentials = options.excludeCredentials.map(c => ({
                ...c, id: base64urlToBuffer(c.id)
            }));
        }

        const credential = await navigator.credentials.create({ publicKey: options });

        const body = {
            id: credential.id,
            rawId: bufferToBase64url(credential.rawId),
            type: credential.type,
            response: {
                attestationObject: bufferToBase64url(credential.response.attestationObject),
                clientDataJSON: bufferToBase64url(credential.response.clientDataJSON)
            }
        };

        const verifyRes = await fetch(`/auth/webauthn/register/verify?name=${encodeURIComponent(name)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        const result = await verifyRes.json();
        if (result.success) {
            statusDiv.innerHTML = '<span class="text-success"><i class="bi bi-check-circle"></i> Passkey registered! Reloading...</span>';
            setTimeout(() => location.reload(), 1000);
        } else {
            throw new Error(result.error);
        }
    } catch (e) {
        statusDiv.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle"></i> ${e.message}</span>`;
    }
}

function base64urlToBuffer(b64) {
    const base64 = b64.replace(/-/g, '+').replace(/_/g, '/');
    const padded = base64 + '=='.slice(0, (4 - base64.length % 4) % 4);
    const bin = atob(padded);
    const bytes = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
    return bytes.buffer;
}

function bufferToBase64url(buf) {
    const bytes = new Uint8Array(buf);
    let bin = '';
    for (let i = 0; i < bytes.length; i++) bin += String.fromCharCode(bytes[i]);
    return btoa(bin).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
}
</script>
{% endif %}
{% endblock %}
